<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>ACL by myclabs</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/myclabs/ACL">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/myclabs/ACL/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/myclabs/ACL/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>ACL</h1>
          <p>Manage permissions on Doctrine entities</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/myclabs">myclabs</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p><a href="https://travis-ci.org/myclabs/ACL"><img src="https://travis-ci.org/myclabs/ACL.png?branch=master" alt="Build Status"></a> <a href="https://coveralls.io/r/myclabs/ACL"><img src="https://coveralls.io/repos/myclabs/ACL/badge.png" alt="Coverage Status"></a> <a href="https://scrutinizer-ci.com/g/myclabs/ACL/"><img src="https://scrutinizer-ci.com/g/myclabs/ACL/badges/quality-score.png?s=2997ec4cb570c1cfef520d541daac853527d173e" alt="Scrutinizer Code Quality"></a> <a href="https://packagist.org/packages/myclabs/acl"><img src="https://poser.pugx.org/myclabs/acl/v/stable.png" alt="Latest Stable Version"></a> <a href="https://packagist.org/packages/myclabs/acl"><img src="https://poser.pugx.org/myclabs/acl/downloads.png" alt="Total Downloads"></a> <a href="https://packagist.org/packages/myclabs/acl"><img src="https://poser.pugx.org/myclabs/acl/license.png" alt="License"></a></p>

<p>MyCLabs ACL is a library that helps managing permissions on resources.</p>

<p>Vocabulary:</p>

<ul>
<li>
<strong>Security identity</strong>: the entity which will be granted some access (this is generally the user)</li>
<li>
<strong>Resource</strong>: a <em>thing</em> to which we want to control the access</li>
<li>
<strong>Authorization</strong>: allows a security identity (user) to do something on a resource</li>
<li>
<strong>Role</strong>: a role gives authorizations to a user (e.g. an administrator, an article editor, a project owner, …)</li>
</ul><p>There are 2 kinds of resources:</p>

<ul>
<li>an entity (example: article #123)</li>
<li>all entities of a given type (example: all articles), which is represented by the classname of the entity</li>
</ul><h2>
<a name="overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h2>

<p>You give permissions to a user by adding it a role:</p>

<div class="highlight highlight-php"><pre><span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">grant</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="k">new</span> <span class="nx">ArticleEditorRole</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$article</span><span class="p">));</span>
</pre></div>

<p>You remove permissions to a user by removing the role:</p>

<div class="highlight highlight-php"><pre><span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">unGrant</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$role</span><span class="p">);</span>
</pre></div>

<p>Test permissions:</p>

<div class="highlight highlight-php"><pre><span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nx">Actions</span><span class="o">::</span><span class="na">EDIT</span><span class="p">,</span> <span class="nv">$article</span><span class="p">);</span>
</pre></div>

<p>You can also filter your queries to get only the entities the user has access to:</p>

<div class="highlight highlight-php"><pre><span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">();</span>
<span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">'article'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">'Model\Article'</span><span class="p">,</span> <span class="s1">'article'</span><span class="p">);</span>

<span class="nx">ACLQueryHelper</span><span class="o">::</span><span class="na">joinACL</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nx">Actions</span><span class="o">::</span><span class="na">EDIT</span><span class="p">);</span>

<span class="c1">// This query will return only the articles the user can edit</span>
<span class="nv">$articles</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
</pre></div>

<h3>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h3>

<ul>
<li>stored in database (you don't need to handle persistence yourself)</li>
<li>extremely optimized:

<ul>
<li>filters queries at database level (you don't load entities the user can't access)</li>
<li>joins with only 1 extra table</li>
</ul>
</li>
<li>authorization cascading/inheritance</li>
<li>authorizations are rebuildable: you can change what an "ArticleEditor" can do afterwards and just rebuild the ACL</li>
<li>supports your custom actions on top of standard actions like "view", "edit", "delete", …</li>
</ul><h3>
<a name="limitations" class="anchor" href="#limitations"><span class="octicon octicon-link"></span></a>Limitations</h3>

<ul>
<li>because of Doctrine limitations you need to flush your resources before giving or testing authorizations</li>
<li>backed up by the database: testing <code>isAllowed</code> means one call to the database</li>
</ul><h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a name="1-mark-your-entity-as-a-resource" class="anchor" href="#1-mark-your-entity-as-a-resource"><span class="octicon octicon-link"></span></a>1. Mark your entity as a resource</h3>

<p>Let's say you want to control the access to an entity named <code>Article</code>.</p>

<p>You need to have your entity implement the <code>EntityResource</code> interface:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">Article</span> <span class="k">implements</span> <span class="nx">EntityResource</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>You can also add an association to the roles that apply on this resource.
Such association is very useful so that the roles (and their authorizations) are deleted in cascade
when the resource is deleted:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">Article</span> <span class="k">implements</span> <span class="nx">EntityResource</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\OneToMany(targetEntity="ArticleEditorRole", mappedBy="article", cascade={"remove"})</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$roles</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>This association can also be useful if you need to find all the "editors" of an article for example.</p>

<h3>
<a name="2-creating-a-new-role" class="anchor" href="#2-creating-a-new-role"><span class="octicon octicon-link"></span></a>2. Creating a new role</h3>

<p>The role gives the authorizations.</p>

<p>To create a new role, extend the <code>Role</code> abstract class:</p>

<div class="highlight highlight-php"><pre><span class="sd">/**</span>
<span class="sd"> * @Entity(readOnly=true)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ArticleEditorRole</span> <span class="k">extends</span> <span class="nx">Role</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ManyToOne(targetEntity="Article", inversedBy="roles")</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$article</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="nx">Article</span> <span class="nv">$article</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">article</span> <span class="o">=</span> <span class="nv">$article</span><span class="p">;</span>

        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createAuthorizations</span><span class="p">(</span><span class="nx">ACL</span> <span class="nv">$acl</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span>
            <span class="nv">$this</span><span class="p">,</span>
            <span class="k">new</span> <span class="nx">Actions</span><span class="p">([</span><span class="nx">Actions</span><span class="o">::</span><span class="na">VIEW</span><span class="p">,</span> <span class="nx">Actions</span><span class="o">::</span><span class="na">EDIT</span><span class="p">]),</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">article</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The authorizations given by the role are created in the <code>createAuthorizations()</code> method.</p>

<p>For creating an authorization, you need to call <code>$acl-&gt;allow()</code> with:</p>

<ul>
<li>the role (which will also provide the user/security identity that is being given access)</li>
<li>the actions that are included in the authorization</li>
<li>the resource</li>
</ul><p>The resource can be either an entity instance (as shown above) or an entity classname, which will
give access to all entities of that type:</p>

<div class="highlight highlight-php"><pre><span class="c1">// This will allow the users having the role to be able to view ALL the articles</span>
<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span>
    <span class="nv">$this</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">Actions</span><span class="p">([</span><span class="nx">Actions</span><span class="o">::</span><span class="na">VIEW</span><span class="p">]),</span>
    <span class="k">new</span> <span class="nx">ClassResource</span><span class="p">(</span><span class="s1">'My\Model\Article'</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<h3>
<a name="actions" class="anchor" href="#actions"><span class="octicon octicon-link"></span></a>Actions</h3>

<p>As you have seen in the previous examples, you can allow and test several actions on a resource.</p>

<ul>
<li><code>allow</code></li>
</ul><p>When allowing access, you can allow the user to do several actions like so:</p>

<div class="highlight highlight-php"><pre><span class="nv">$actions</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Actions</span><span class="p">();</span>
<span class="nv">$actions</span><span class="o">-&gt;</span><span class="na">view</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="nv">$actions</span><span class="o">-&gt;</span><span class="na">edit</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$actions</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">);</span>
</pre></div>

<p>The way shown in the examples above is a shortcut, sometimes more practical:</p>

<div class="highlight highlight-php"><pre><span class="nv">$actions</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Actions</span><span class="p">([</span>
    <span class="nx">Actions</span><span class="o">::</span><span class="na">VIEW</span><span class="p">,</span>
    <span class="nx">Actions</span><span class="o">::</span><span class="na">EDIT</span><span class="p">,</span>
<span class="p">]);</span>

<span class="k">echo</span> <span class="nv">$actions</span><span class="o">-&gt;</span><span class="na">view</span><span class="p">;</span> <span class="c1">// true</span>
<span class="k">echo</span> <span class="nv">$actions</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">;</span> <span class="c1">// false</span>
</pre></div>

<ul>
<li><code>isAllowed</code></li>
</ul><p>When testing access, you can only test for one action:</p>

<div class="highlight highlight-php"><pre><span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nx">Actions</span><span class="o">::</span><span class="na">EDIT</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">);</span>
</pre></div>

<p>Here is the list of all actions natively supported:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">Actions</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">VIEW</span> <span class="o">=</span> <span class="s1">'view'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">CREATE</span> <span class="o">=</span> <span class="s1">'create'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">EDIT</span> <span class="o">=</span> <span class="s1">'edit'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">DELETE</span> <span class="o">=</span> <span class="s1">'delete'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">UNDELETE</span> <span class="o">=</span> <span class="s1">'undelete'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">ALLOW</span> <span class="o">=</span> <span class="s1">'allow'</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$view</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$create</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$delete</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$undelete</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$allow</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="c1">// ....</span>
<span class="p">}</span>
</pre></div>

<p>You don't have to use them all if you don't need it.</p>

<p>FYI, <code>ALLOW</code> means "the user is allowed to allow other users on this resource", i.e. it's the action
of managing access on the resource. This is usually what an administrator does: he can configure the
accesses on the resources he administrates.</p>

<h2>
<a name="setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h2>

<p>You first need to register the annotation mapping to your Doctrine metadata driver.</p>

<p>Creating the ACL is simple:</p>

<div class="highlight highlight-php"><pre><span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ACL</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">);</span>
</pre></div>

<p>However, you must register some listener on the entity manager:</p>

<div class="highlight highlight-php"><pre><span class="nv">$aclSetup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\MyCLabs\ACL\Doctrine\ACLSetup</span><span class="p">();</span>
<span class="c1">// Set which class implements the SecurityIdentityInterface (must be called once)</span>
<span class="nv">$aclSetup</span><span class="o">-&gt;</span><span class="na">setSecurityIdentityClass</span><span class="p">(</span><span class="s1">'My\Model\User'</span><span class="p">)</span>
<span class="c1">// Register role classes</span>
<span class="nv">$aclSetup</span><span class="o">-&gt;</span><span class="na">registerRoleClass</span><span class="p">(</span><span class="s1">'My\Model\ArticleEditorRole'</span><span class="p">,</span> <span class="s1">'articleEditor'</span><span class="p">);</span>

<span class="c1">// To avoid instantiating the ACL uselessly (and avoid a circular dependency),</span>
<span class="c1">// we must use a "locator" callback</span>
<span class="nv">$aclLocator</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'MyCLabs\ACL\ACL'</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Apply the configuration to the entity manager</span>
<span class="nv">$aclSetup</span><span class="o">-&gt;</span><span class="na">setUpEntityManager</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">,</span> <span class="nv">$aclLocator</span><span class="p">);</span>
</pre></div>

<h2>
<a name="authorization-cascading" class="anchor" href="#authorization-cascading"><span class="octicon octicon-link"></span></a>Authorization cascading</h2>

<p>There are 2 ways to cascade authorizations:</p>

<ul>
<li>via a hierarchy of resource: parent resources cascade their authorizations to sub-resources</li>
<li>via a custom cascading strategy (if you have exotic needs)</li>
</ul><p>The first solution is supported out of the box. Example: allowing a user to access a folder and all its sub-folders.</p>

<p>You have 2 solutions to define the hierarchical structure:</p>

<ul>
<li>implementing the <code>CascadingResource</code> interface</li>
<li>writing a <code>ResourceGraphTraverser</code>
</li>
</ul><h3>
<a name="cascadingresource" class="anchor" href="#cascadingresource"><span class="octicon octicon-link"></span></a>CascadingResource</h3>

<p>This is a very simple solution, yet a bit limited, and it crowds your entity a bit.</p>

<p>Example:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">Category</span> <span class="k">implements</span> <span class="nx">EntityResource</span><span class="p">,</span> <span class="nx">CascadingResource</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var Category[] Sub-categories</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$children</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var Category|null Parent category</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$parent</span><span class="p">;</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getParentResources</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$parents</span> <span class="o">=</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">ClassResource</span><span class="p">(</span><span class="nb">get_class</span><span class="p">())</span> <span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parent</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$parents</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parent</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$parents</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubResources</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">children</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Note: if you want to give authorizations on the class-resource "All categories" (<code>new ClassResource('Category')</code>)
don't forget to return it in <code>getParentResources()</code> (as shown above). Else you can ignore it.</p>

<p>Just so you know, <code>ClassResource</code> implements the <code>CascadingResource</code> interface:</p>

<div class="highlight highlight-php"><pre><span class="k">final</span> <span class="k">class</span> <span class="nc">ClassResource</span> <span class="k">implements</span> <span class="nx">ResourceInterface</span><span class="p">,</span> <span class="nx">CascadingResource</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSubResources</span><span class="p">(</span><span class="nx">EntityManager</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><strong>Important</strong>: with <code>CascadingResource</code>, MyCLabs\ACL will assume each resource only returns its direct
children/parent resources. So they will be traversed recursively, which sometimes can be inefficient.
Have a look below for an alternative solution.</p>

<h3>
<a name="resourcegraphtraverser" class="anchor" href="#resourcegraphtraverser"><span class="octicon octicon-link"></span></a>ResourceGraphTraverser</h3>

<p>The <code>ResourceGraphTraverser</code> is an object you write that must return the parent and sub-resources of a resource.</p>

<p>As explained, it must return <strong>all</strong> the sub/parent resources, which avoids MyCLabs\ACL
recursively looking for sub/parent resources.</p>

<p>Example:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">FolderResourceGraphTraverser</span> <span class="k">implements</span> <span class="nx">ResourceGraphTraverser</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAllParentResources</span><span class="p">(</span><span class="nx">ResourceInterface</span> <span class="nv">$resource</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$resource</span> <span class="nx">instanceof</span> <span class="nx">Folder</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$parents</span> <span class="o">=</span> <span class="nv">$resource</span><span class="o">-&gt;</span><span class="na">getAllParentFoldersRecursively</span><span class="p">();</span>
        <span class="nv">$parents</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ClassResource</span><span class="p">(</span><span class="nx">Folder</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$parents</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAllSubResources</span><span class="p">(</span><span class="nx">ResourceInterface</span> <span class="nv">$resource</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$resource</span> <span class="nx">instanceof</span> <span class="nx">Folder</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">(</span>
            <span class="nv">$resource</span><span class="o">-&gt;</span><span class="na">getAllSubFoldersRecursively</span><span class="p">(),</span>
            <span class="nv">$resource</span><span class="o">-&gt;</span><span class="na">getAllFiles</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>To register it:</p>

<div class="highlight highlight-php"><pre><span class="nv">$cascadeStrategy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleCascadeStrategy</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">);</span>
<span class="nv">$cascadeStrategy</span><span class="o">-&gt;</span><span class="na">setResourceGraphTraverser</span><span class="p">(</span>
    <span class="nx">Folder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="nv">$c</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">FolderResourceGraphTraverser</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
<span class="p">);</span>

<span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ACL</span><span class="p">(</span><span class="nv">$em</span><span class="p">,</span> <span class="nv">$cascadeStrategy</span><span class="p">);</span>
</pre></div>

<h2>
<a name="custom-actions" class="anchor" href="#custom-actions"><span class="octicon octicon-link"></span></a>Custom actions</h2>

<p>The default actions that you can use are:</p>

<ul>
<li>view</li>
<li>edit</li>
<li>delete</li>
<li>undelete</li>
<li>allow (= manage permissions on the resource)</li>
<li>create</li>
</ul><p>You can add your own actions by overriding the <code>Actions</code> class:</p>

<div class="highlight highlight-php"><pre><span class="k">namespace</span> <span class="nx">My\Model</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyCLabs\ACL\Model\Actions</span> <span class="k">as</span> <span class="nx">BaseActions</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Embeddable</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Actions</span> <span class="k">extends</span> <span class="nx">BaseActions</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">PUBLISH</span> <span class="o">=</span> <span class="s1">'publish'</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type = "boolean")</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="nv">$publish</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * {@inheritdoc}</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">all</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="k">static</span><span class="p">([</span>
            <span class="k">static</span><span class="o">::</span><span class="na">VIEW</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">CREATE</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">EDIT</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">DELETE</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">UNDELETE</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">ALLOW</span><span class="p">,</span>
            <span class="k">static</span><span class="o">::</span><span class="na">PUBLISH</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Here we added a "publish" action to restrict who can publish articles.</p>

<p>Now we need to configure MyCLabs\ACL to use this class instead of the base class:</p>

<div class="highlight highlight-php"><pre><span class="nv">$aclSetup</span><span class="o">-&gt;</span><span class="na">setActionsClass</span><span class="p">(</span><span class="s1">'My\Model\Actions'</span><span class="p">);</span>
</pre></div>

<h2>
<a name="performances" class="anchor" href="#performances"><span class="octicon octicon-link"></span></a>Performances</h2>

<p>For better performances, you can follow the following advices:</p>

<ul>
<li>Cache calls to <code>isAllowed()</code>: every time you call that method, it will issue a query to the database.</li>
</ul><p>You shouldn't call <code>isAllowed()</code> a lot, if you do try instead to filter your queries using the ACL (see above),
this is much more efficient. However, if you do, you might want to cache the results of those calls in order
to avoid doing too many queries.</p>

<p>MyCLabs\ACL doesn't ship with a cache for now because there are some problems associated to it, mainly
cache invalidation when ACLs changes. However this can change, you are free to file an issue for this.</p>

<p>Be aware that using a cache for this is not mandatory. If your application doesn't handle a lot of traffic
the ACL system will work just fine (the isAllowed query is very simple and optimized).</p>

<ul>
<li>Roles should be set as "Read Only" for Doctrine so that they are not tracked for changes uselessly</li>
</ul><p>This is minor, but why not.
This is not a hard requirement though, if your roles can change, you are free to ignore this.</p>

<p>Example with annotations:</p>

<div class="highlight highlight-php"><pre><span class="sd">/**</span>
<span class="sd"> * @Entity(readOnly=true)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">ArticleEditorRole</span> <span class="k">extends</span> <span class="nx">Role</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>

<p>Or with YAML:</p>

<div class="highlight highlight-yaml"><pre><span class="l-Scalar-Plain">Namespace\ArticleEditorRole</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">entity</span>
  <span class="l-Scalar-Plain">readOnly</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>